trigger:
  branches:
    include:
      - main

pr: none

variables:
  NODE_VERSION: "20.x"
  PUBLISH: "true"

stages:
  # ---------------------------
  # Stage 1: Build, Test, Pack
  # ---------------------------
  - stage: BuildAndPack
    displayName: "Build and Pack"
    jobs:
      - job: build
        displayName: "Build/Test/Pack"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            fetchDepth: 0

          - task: NodeTool@0
            inputs:
              versionSpec: "$(NODE_VERSION)"
            displayName: "Use Node $(NODE_VERSION)"

          - script: npm ci
            displayName: "Install"

          - script: npm test
            displayName: "Test"

          - script: npm run build
            displayName: "Build"

          - script: |
              set -euo pipefail

              echo "Dry-run pack (must not include tests or release artifacts):"
              npm pack --dry-run

              echo "Fail if any test files would be published:"
              npm pack --dry-run | grep -E "dist/.*test" && exit 1 || true

              echo "Fail if any release folder content would be published:"
              npm pack --dry-run | grep -E "npm notice .*release/" && exit 1 || true

              echo "Create tarball:"
              npm pack

              echo "List tarball(s):"
              ls -la *.tgz

              echo "Stage tarball(s) into artifact staging directory:"
              mkdir -p "$(Build.ArtifactStagingDirectory)/npm-tarball"
              mv *.tgz "$(Build.ArtifactStagingDirectory)/npm-tarball/"

              echo "Staged files:"
              ls -la "$(Build.ArtifactStagingDirectory)/npm-tarball"
            displayName: "Pack + Guards + Stage tarball"

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: "$(Build.ArtifactStagingDirectory)/npm-tarball"
              artifact: "npm-tarball"
            displayName: "Publish tarball artifact"

  # ------------------------------------
  # Stage 2: Manual approval (only if PUBLISH=true)
  # ------------------------------------
  - stage: Approve
    displayName: "Approve Publish"
    dependsOn: BuildAndPack
    condition: and(succeeded(), eq(variables['PUBLISH'], 'true'))
    jobs:
      - job: manual
        displayName: "Manual Validation"
        pool: server
        timeoutInMinutes: 1440
        steps:
          - task: ManualValidation@0
            inputs:
              instructions: |
                Approve to publish the tarball to npm.

                Checklist:
                - Confirm this main commit is what you intend to publish
                - Confirm npm pack --dry-run looked correct (no tests, no release/)
                - Confirm package.json version is correct
              onTimeout: "reject"

  # ---------------------------
  # Stage 3: Publish to npm (only if approved)
  # ---------------------------
  - stage: Publish
    displayName: "Publish to npm"
    dependsOn: Approve
    condition: succeeded()
    jobs:
      - job: publish
        displayName: "Publish Tarball"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - download: current
            artifact: "npm-tarball"
            displayName: "Download tarball artifact"

          - task: NodeTool@0
            inputs:
              versionSpec: "$(NODE_VERSION)"
            displayName: "Use Node $(NODE_VERSION)"

          - script: |
              set -euo pipefail

              cd "$(Pipeline.Workspace)/npm-tarball"
              echo "Files downloaded for publish:"
              ls -la

              npm config set //registry.npmjs.org/:_authToken=$(NPM_TOKEN)

              echo "Publishing tarball:"
              npm publish *.tgz --access public
            displayName: "npm publish"
            env:
              NPM_TOKEN: $(NPM_TOKEN)
